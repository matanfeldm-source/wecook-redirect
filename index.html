<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opening WeCook...</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: #FDF7F0;
            color: #333;
        }
        .container {
            text-align: center;
            padding: 2rem;
            max-width: 400px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8FBC94;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #fallback, #error {
            display: none;
            margin-top: 1rem;
        }
        a {
            color: #8FBC94;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: #8FBC94;
            color: white;
            border-radius: 8px;
            transition: background 0.2s;
        }
        a:hover {
            background: #7aab7f;
        }
        h2 {
            margin: 1rem 0 0.5rem;
            color: #333;
        }
        p {
            color: #666;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="spinner" class="spinner"></div>
        <h2>Opening WeCook...</h2>
        <p>If the app doesn't open automatically, tap the link below:</p>
        <div id="fallback">
            <a id="link" href="#">Tap to Open App</a>
        </div>
        <div id="error">
            <p>Recipe ID not found. Please check the link.</p>
            <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">URL format: your-domain.com/?id=RECIPE_ID or /recipe/RECIPE_ID</p>
            <div id="debug" style="display: none; margin-top: 1rem; padding: 1rem; background: #f0f0f0; border-radius: 4px; font-size: 0.8rem; text-align: left;">
                <strong>Debug Info:</strong><br>
                <span id="debug-url"></span><br>
                <span id="debug-path"></span><br>
                <span id="debug-id"></span>
            </div>
        </div>
    </div>
    <script>
        (function() {
            // Get recipe ID from query parameter or path
            function getRecipeId() {
                // Try query parameter first
                const urlParams = new URLSearchParams(window.location.search);
                const queryId = urlParams.get('id');
                if (queryId) {
                    console.log('Found recipe ID from query:', queryId);
                    return queryId;
                }
                
                // Try path as fallback: /wecook-redirect/recipe/{id}
                const pathParts = window.location.pathname.split('/').filter(p => p);
                console.log('Path parts:', pathParts);
                console.log('Full pathname:', window.location.pathname);
                
                const recipeIndex = pathParts.indexOf('recipe');
                if (recipeIndex !== -1 && pathParts[recipeIndex + 1]) {
                    const id = pathParts[recipeIndex + 1];
                    console.log('Found recipe ID from path:', id);
                    return id;
                }
                
                // Try last path segment if it looks like an ID
                if (pathParts.length > 0) {
                    const lastPart = pathParts[pathParts.length - 1];
                    if (lastPart && lastPart.length >= 10 && /^[a-zA-Z0-9]+$/.test(lastPart)) {
                        console.log('Found recipe ID from last segment:', lastPart);
                        return lastPart;
                    }
                }
                
                console.log('No recipe ID found');
                return null;
            }
            
            function showError() {
                try {
                    const errorEl = document.getElementById('error');
                    const spinnerEl = document.getElementById('spinner');
                    if (errorEl) errorEl.style.display = 'block';
                    if (spinnerEl) spinnerEl.style.display = 'none';
                    
                    // Show debug info
                    const debugEl = document.getElementById('debug');
                    const debugUrlEl = document.getElementById('debug-url');
                    const debugPathEl = document.getElementById('debug-path');
                    const debugIdEl = document.getElementById('debug-id');
                    
                    if (debugEl) debugEl.style.display = 'block';
                    if (debugUrlEl) debugUrlEl.textContent = 'URL: ' + window.location.href;
                    if (debugPathEl) debugPathEl.textContent = 'Path: ' + window.location.pathname;
                    if (debugIdEl) debugIdEl.textContent = 'Path Parts: ' + JSON.stringify(window.location.pathname.split('/').filter(p => p));
                } catch (e) {
                    console.error('Error showing error message:', e);
                }
            }
            
            function showFallback(deepLink) {
                try {
                    const fallbackEl = document.getElementById('fallback');
                    const linkEl = document.getElementById('link');
                    if (fallbackEl) fallbackEl.style.display = 'block';
                    if (linkEl) {
                        linkEl.href = deepLink;
                        linkEl.textContent = 'Tap to Open App';
                    }
                } catch (e) {
                    console.error('Error showing fallback:', e);
                }
            }
            
            const recipeId = getRecipeId();
            console.log('Final recipe ID:', recipeId);
            console.log('Full URL:', window.location.href);
            
            if (recipeId && recipeId !== 'index.html' && recipeId !== 'redirect.html' && recipeId !== '' && recipeId !== 'wecook-redirect') {
                // Try to open app with custom scheme
                const deepLink = 'wecook://recipe/' + recipeId;
                console.log('Redirecting to:', deepLink);
                
                // Attempt to open the app immediately
                try {
                    window.location.href = deepLink;
                } catch (e) {
                    console.error('Error redirecting:', e);
                    showError();
                    return;
                }
                
                // Fallback: if app doesn't open, show message after 2 seconds
                setTimeout(function() {
                    showFallback(deepLink);
                }, 2000);
            } else {
                console.log('No valid recipe ID found, showing error');
                showError();
            }
        })();
    </script>
</body>
</html>
